describe("Ext.data.writer.Json",function(){var D,C,E,B,A,F={id:1,title:"Article 1",body:"content1"};beforeEach(function(){Ext.ClassManager.enableNamespaceParseCache=false;C=function(G){G=Ext.apply({writeAllFields:true},G);D=new Ext.data.writer.Json(G)};A=Ext.define("spec.Article",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"title",type:"string"},{name:"body",type:"string",writeName:"content"}]});E=function(H){var G=[];Ext.each(H,function(I){G.push(new A(I))});return G};B=function(G){return new Ext.data.operation.Create({records:G})}});afterEach(function(){Ext.ClassManager.enableNamespaceParseCache=true;D=C=B=A=null;Ext.data.Model.schema.clear();Ext.undefine("spec.Article")});describe("initialization",function(){it("should default root to undefined",function(){C();expect(D.getRootProperty()).toBeUndefined()});it("should default encode to false",function(){C();expect(D.getEncode()).toBe(false)});it("should default allowSingle to true",function(){C();expect(D.getAllowSingle()).toBe(true)});it("should default expandData to false",function(){C();expect(D.getExpandData()).toBe(false)})});describe("allowSingle",function(){it("should only send a single record if allowSingle is true and there's only 1 item",function(){C();var G=D.write(new Ext.data.Request({operation:B(E([F]))}));var H=G.getJsonData();expect(H).toEqual(F)});it("should wrap a single record in an array if allowSingle is false",function(){C({allowSingle:false});var G=D.write(new Ext.data.Request({operation:B(E([F]))}));expect(G.getJsonData()).toEqual([F])});it("should wrap records in an array if there is more than 1, regardless of allowSingle",function(){C();var G=D.write(new Ext.data.Request({operation:B(E([F,{id:2,title:"Article 2",body:"content2"}]))}));expect(G.getJsonData()).toEqual([F,{id:2,title:"Article 2",body:"content2"}])})});describe("with encode: true",function(){it("should throw an exception if no root is specified",function(){C({encode:true});expect(function(){D.write(new Ext.data.Request({operation:B(E([F]))}))}).toRaiseExtError()});it("should write the data to the request params",function(){C({encode:true,rootProperty:"root"});var G=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(G.getParams().root).toBeDefined()});it("should encode the data",function(){C({encode:true,rootProperty:"root"});var G=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(G.getParams().root).toBe(Ext.encode(F))})});describe("with encode: false",function(){it("should create the jsonData if it doesn't exist",function(){C();var G=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(G.getJsonData()).toBeDefined()});it("should write directly to the jsonData if no root is specified",function(){C();var G=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(G.getJsonData()).toEqual(F)});it("should write to the root property jsonData if specified",function(){C({rootProperty:"root"});var G=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(G.getJsonData()).toEqual({root:F})})});describe("nested data mappings",function(){var G;beforeEach(function(){Ext.data.Model.schema.clear();A=Ext.define("spec.Article",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"title",type:"string",mapping:"my_title"},{name:"someNestedProperty",type:"string",mapping:"some.nested.property"},{name:"someOtherProperty",type:"string",mapping:"some.other.property"},{name:"someOtherProperty2",type:"int",mapping:"some.other.property2"}]});G={id:1,title:"Article 1",someNestedProperty:"nested",someOtherProperty:"other",someOtherProperty2:5}});it("should write as flat output using the default field names by default",function(){C();var H=D.write(new Ext.data.Request({operation:B(E([G]))}));expect(H.getJsonData()).toEqual(G)});it("should write as flat output using the mapped field names by default when nameProperty is used",function(){C({nameProperty:"mapping"});var H=D.write(new Ext.data.Request({operation:B(E([G]))}));expect(H.getJsonData()).toEqual({id:1,my_title:"Article 1","some.nested.property":"nested","some.other.property":"other","some.other.property2":5})});it("should expand output to nested JSON when nameProperty is used and expandData = true",function(){C({nameProperty:"mapping",expandData:true});var H=D.write(new Ext.data.Request({operation:B(E([G]))}));expect(H.getJsonData()).toEqual({id:1,my_title:"Article 1",some:{nested:{property:"nested"},other:{property:"other",property2:5}}})})});describe("transform",function(){it("should invoke the transform function",function(){var H=function(I){return{id:2}};C({transform:H});var G=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(G.getJsonData()).not.toEqual(F);expect(G.getJsonData()).toEqual({id:2})});it("should invoke the transform function with the specified scope",function(){var G={};var I=function(J){expect(this).toEqual(G);return{id:2}};C({transform:{fn:I,scope:G}});var H=D.write(new Ext.data.Request({params:{},operation:B(E([F]))}));expect(H.getJsonData()).not.toEqual(F);expect(H.getJsonData()).toEqual({id:2})})})});