describe("Ext.data.writer.Writer",function(){var C,B,A,E,D;beforeEach(function(){Ext.ClassManager.enableNamespaceParseCache=false;B=function(F){F=Ext.apply({writeAllFields:true},F);F=Ext.apply(F,{model:spec.Article});C=new Ext.data.writer.Writer(F)};A=Ext.define("spec.Article",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"title",type:"string"},{name:"body",type:"string",writeName:"content"},{name:"isRead",type:"boolean",persist:false}]});E=new A({id:1,title:"Foo",body:"Bar"});D=new Ext.data.operation.Create({records:[E]})});afterEach(function(){Ext.ClassManager.enableNamespaceParseCache=true;Ext.data.Model.schema.clear();Ext.undefine("spec.Article")});describe("initialization",function(){it("should default writeAllFields to false",function(){var F=new Ext.data.writer.Writer();expect(F.getWriteAllFields()).toBe(false)});it("should default nameProperty to 'name'",function(){B();expect(C.getNameProperty()).toBe("name")})});describe("getRecordData",function(){it("should return undeclared fields in the model",function(){B();E.data.something=1;var F=C.getRecordData(E,D);expect(F.something).toBe(1)});it("should write all fields in the model",function(){B();var F=C.getRecordData(E,D);expect(F).toEqual({id:1,title:"Foo",body:"Bar"})});it("should ignore any fields with persist: false",function(){B();var F=C.getRecordData(E,D);expect(F.isRead).toBeUndefined()});it("should write the id as the clientIdProperty if the record is a phantom",function(){B({clientIdProperty:"cid"});E=new A({title:"Foo",body:"Bar"});D.setRecords([E]);var F=C.getRecordData(E,D);expect(F).toEqual({cid:E.id,title:"Foo",body:"Bar"})});it("should write the generated id if the record is a phantom",function(){B();A.prototype.clientIdProperty="clientId";E=new A({title:"Foo",body:"Bar"});D.setRecords([E]);var F=C.getRecordData(E,D);A.prototype.clientIdProperty=null;expect(F).toEqual({id:E.id,title:"Foo",body:"Bar"})});it("should write the idProperty for all non-phantom records by default",function(){B();E=new A({id:1,title:"Foo",body:"Bar"});var F=C.getRecordData(E,D);expect(F).toEqual({id:1,title:"Foo",body:"Bar"})});describe("delete",function(){var F;beforeEach(function(){E=new A({id:1,title:"Foo",body:"Bar"});F=new Ext.data.operation.Destroy({records:[E]})});it("should return an object containing all fields",function(){B();var G=C.getRecordData(E,F);expect(G).toEqual({id:1,title:"Foo",body:"Bar"})});it("should return an object with only the id if writeAllFields is false",function(){B({writeAllFields:false});var G=C.getRecordData(E,F);expect(G).toEqual({id:1})})});describe("writeAllFields: false",function(){beforeEach(function(){B({writeAllFields:false})});it("should return an object with only the id if nothing is modified",function(){var F=C.getRecordData(E,D);expect(F).toEqual({id:1})});it("should return an empty object if nothing is modified when writeRecordId = false",function(){B({writeAllFields:false,writeRecordId:false});var F=C.getRecordData(E,D);expect(F).toEqual({})});it("should return only the modified fields and the id",function(){E.set("title","other");var F=C.getRecordData(E,D);expect(F).toEqual({id:1,title:"other"})});it("should return the modified fields except id if the record is a non-phantom and writeRecordId = false",function(){B({writeAllFields:false,writeRecordId:false});E.set("title","other");var F=C.getRecordData(E,D);expect(F).toEqual({title:"other"})});it("should write all fields if the record is a phantom",function(){E=new A({title:"Foo",body:"Bar"});var F=C.getRecordData(E,D);expect(F).toEqual({id:E.id,title:"Foo",body:"Bar"})});describe("dates",function(){beforeEach(function(){Ext.define("MyModel",{extend:"Ext.data.Model",fields:[{name:"myDate",type:"date",dateFormat:"Y/m/d"},{name:"timestamp",type:"date",dateFormat:"timestamp"},{name:"time",type:"date",dateFormat:"time"},{name:"dateWriteFormat",type:"date",dateWriteFormat:"Y-m-d",dateFormat:"Y|M|D"}]})});afterEach(function(){Ext.undefine("MyModel")});it("should serialize Dates using the dateFormat",function(){var I=new MyModel({myDate:new Date(1962,5,17)}),H=new Ext.data.operation.Create({records:[I]}),G=new Ext.data.writer.Writer({}),F=G.getRecordData(I,H);expect(F.myDate).toBe("1962/06/17")});it("should respect the timestamp format",function(){var J=new Date();var I=new MyModel({timestamp:new Date(Ext.Date.format(J,"U")*1000)}),H=new Ext.data.operation.Create({records:[I]}),F=new Ext.data.writer.Writer({}),G=F.getRecordData(I,H);expect(G.timestamp).toBe(Ext.Date.format(J,"U"))});it("should respect the time format",function(){var J=new Date();var I=new MyModel({time:new Date(J.getTime())}),H=new Ext.data.operation.Create({records:[I]}),F=new Ext.data.writer.Writer({}),G=F.getRecordData(I,H);expect(G.time).toBe(J.getTime().toString())});it("should send null for dates when the date is null",function(){var I=new MyModel({}),H=new Ext.data.operation.Create({records:[I]}),G=new Ext.data.writer.Writer({}),F=G.getRecordData(I,H);expect(F.myDate).toBe(null)});it("should give precedence to writeFormat",function(){var I=new MyModel({dateWriteFormat:new Date(2012,0,1)}),H=new Ext.data.operation.Create({records:[I]}),G=new Ext.data.writer.Writer({dateFormat:"Y/m/d"}),F=G.getRecordData(I,H);expect(F.dateWriteFormat).toBe("2012/01/01")});it("should give precedence to the writer dateFormat",function(){var I=new MyModel({myDate:new Date(2012,0,1)}),H=new Ext.data.operation.Create({records:[I]}),G=new Ext.data.writer.Writer({dateFormat:"Y/m/d"}),F=G.getRecordData(I,H);expect(F.myDate).toBe("2012/01/01")})});it("should serialize using the Field's serialize",function(){Ext.define("MyModel",{extend:"Ext.data.Model",fields:[{name:"myDate",type:"date",dateFormat:"Y/m/d",serialize:function(){return"test"}}]});var I=new MyModel({myDate:"1962/06/17"}),H=new Ext.data.operation.Create({records:[I]}),G=new Ext.data.writer.Writer({}),F=G.getRecordData(I,H);delete F.id;expect(F).toEqual({myDate:"test"});Ext.undefine("MyModel")})});describe("nameProperty",function(){it("should use the nameProperty",function(){B({writeAllFields:false,nameProperty:"writeName"});E.set("body","new body");var F=C.getRecordData(E,D);expect(F).toEqual({id:1,content:"new body"})});it("should fall back to the name property",function(){B({nameProperty:"writeName"});var F=C.getRecordData(E,D);expect(F).toEqual({id:1,title:"Foo",content:"Bar"})});it("should write mapped names correctly when phantom = false",function(){B({writeAllFields:true,nameProperty:"writeName"});Ext.data.Model.schema.clear();A=Ext.define("spec.Article",{extend:"Ext.data.Model",fields:[{name:"id",type:"int",writeName:"mapped_id"},{name:"title",type:"string",writeName:"mapped_title"},{name:"body",type:"string",writeName:"mapped_body"}]});E=new A({id:123,title:"Foo",body:"Bar",phantom:false});var F=C.getRecordData(E,D);expect(F).toEqual({mapped_id:123,mapped_title:"Foo",mapped_body:"Bar",phantom:false})})})})});