describe("Ext.event.gesture.Drag",function(){var I=Ext.testHelper,L=Ext.event.Dispatcher.getInstance().getPublisher("gesture").getRecognizers().drag,J=L.getMinDistance(),D,E,O,P,B,C,H,A,K;function Q(S,T){I.touchStart(T||D,S)}function M(S,T){I.touchMove(T||D,S)}function F(S,T){I.touchEnd(T||D,S)}function G(S,T){I.touchCancel(T||D,S)}function N(S,U){var T;for(T in U){expect(S[T]).toBe(U[T])}}beforeEach(function(){D=Ext.getBody().createChild({});E=jasmine.createSpy();O=jasmine.createSpy();P=jasmine.createSpy();B=jasmine.createSpy();E.andCallFake(function(S){C=S});O.andCallFake(function(S){H=S});P.andCallFake(function(S){A=S});B.andCallFake(function(S){K=S});D.on("dragstart",E);D.on("drag",O);D.on("dragend",P);D.on("dragcancel",B)});afterEach(function(){D.destroy()});it("should fire dragstart, drag, and dragend when the distance exceeds minDistance",function(){runs(function(){Q({id:1,x:100,y:101});M({id:1,x:99,y:101-J})});waitsForAnimation();runs(function(){expect(E).toHaveBeenCalled();expect(O).toHaveBeenCalled();N(C,{x:99,y:101-J,pageX:99,pageY:101-J,startX:100,startY:101,previousX:100,previousY:101,deltaX:-1,deltaY:-J,absDeltaX:1,absDeltaY:J,previousDeltaX:0,previousDeltaY:0});N(H,{x:99,y:101-J,pageX:99,pageY:101-J,startX:100,startY:101,previousX:100,previousY:101,deltaX:-1,deltaY:-J,absDeltaX:1,absDeltaY:J,previousDeltaX:0,previousDeltaY:0});M({id:1,x:97,y:100-J})});waitsForAnimation();runs(function(){expect(O.callCount).toBe(2);N(H,{x:97,y:100-J,pageX:97,pageY:100-J,startX:100,startY:101,previousX:99,previousY:101-J,deltaX:-3,deltaY:-(J+1),absDeltaX:3,absDeltaY:J+1,previousDeltaX:-1,previousDeltaY:-J});F({id:1,x:96,y:99-J})});waitsForAnimation();runs(function(){expect(P).toHaveBeenCalled();N(A,{x:96,y:99-J,pageX:96,pageY:99-J,startX:100,startY:101,previousX:97,previousY:100-J,deltaX:-4,deltaY:-(J+2),absDeltaX:4,absDeltaY:J+2,previousDeltaX:-3,previousDeltaY:-(J+1)})})});it("should not fire dragstart, drag, and dragend when the distance is less than minDistance",function(){runs(function(){Q({id:1,x:100,y:101});M({id:1,x:99,y:99+J});F({id:1,x:99,y:99+J})});waitsForAnimation();runs(function(){expect(E).not.toHaveBeenCalled();expect(O).not.toHaveBeenCalled();expect(P).not.toHaveBeenCalled()})});if(Ext.supports.Touch){it("should fire dragcancel and not dragend if the touch is canceled after dragstart",function(){runs(function(){Q({id:1,x:100,y:101});M({id:1,x:99,y:101-J})});waitsForAnimation();runs(function(){expect(E).toHaveBeenCalled();expect(O).toHaveBeenCalled();M({id:1,x:97,y:100-J})});waitsForAnimation();runs(function(){expect(O.callCount).toBe(2);G({id:1,x:96,y:99-J})});waitsForAnimation();runs(function(){expect(P).not.toHaveBeenCalled();expect(B).toHaveBeenCalled();N(K,{x:96,y:99-J,pageX:96,pageY:99-J,startX:100,startY:101,previousX:97,previousY:100-J,deltaX:-4,deltaY:-(J+2),absDeltaX:4,absDeltaY:J+2,previousDeltaX:-3,previousDeltaY:-(J+1)})})})}it("should have the correct e.target if the mouse is moved off of the target",function(){runs(function(){Q({id:1,x:500,y:300});I.touchMove(document.body,{id:1,x:200,y:700})});waitsForAnimation();runs(function(){expect(H.target).toBe(D.dom);F({id:1,x:200,y:700})});waitsForAnimation()});function R(S){describe("when the target element is removed from the dom mid-drag "+(S?"(using removeChild)":"(using innerHTML)"),function(){var W,V,T;function U(){if(S){W.dom.removeChild(V.dom)}else{W.dom.innerHTML=""}}beforeEach(function(){W=Ext.getBody().createChild({id:"parent"});V=W.createChild({id:"child"});if(Ext.supports.TouchEvents){T=V}else{T=document.body}});afterEach(function(){W.destroy();V.destroy()});it("should recover gracefully when the listener is attached above the target",function(){runs(function(){W.on("drag",O);W.on("dragend",P);Q({id:1,x:100,y:100},V);M({id:1,x:100,y:100+J},V)});waitsForAnimation();runs(function(){expect(O.callCount).toBe(1);U();M({id:1,x:120,y:150+J},T)});waitsForAnimation();runs(function(){expect(O.callCount).toBe(2);expect(H.target).toBe(V.dom);F({id:1,x:120,y:150+J},T)});waitsForAnimation();runs(function(){expect(P).toHaveBeenCalled();expect(A.target).toBe(V.dom)})});it("should recover gracefully when the listener is attached to the target",function(){runs(function(){V.on("drag",O);V.on("dragend",P);Q({id:1,x:100,y:100},V);M({id:1,x:100,y:100+J},V)});waitsForAnimation();runs(function(){expect(O.callCount).toBe(1);U();M({id:1,x:120,y:150+J},T)});waitsForAnimation();runs(function(){expect(O.callCount).toBe(2);expect(H.target).toBe(V.dom);F({id:1,x:120,y:150+J},T)});waitsForAnimation();runs(function(){expect(P).toHaveBeenCalled();expect(A.target).toBe(V.dom)})})})}R(true);R(false)});