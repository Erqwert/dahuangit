describe("Ext.data.proxy.Server",function(){var A,C=Ext.data.proxy.Server,B=new Ext.data.reader.Reader(),D=new Ext.data.writer.Writer();beforeEach(function(){Ext.ClassManager.enableNamespaceParseCache=false});afterEach(function(){Ext.ClassManager.enableNamespaceParseCache=true;Ext.data.Model.schema.clear();Ext.undefine("spec.SomeModel")});describe("instantiation",function(){var E;beforeEach(function(){E={extraParams:{foo:true,bar:false},reader:B,writer:D};A=new C(E)});it("should extend Ext.data.proxy.Proxy",function(){expect(A.superclass).toEqual(Ext.data.proxy.Proxy.prototype)});it("should have caching disabled",function(){expect(A.getNoCache()).toBe(true)});it("should have cacheString equal to _dc",function(){expect(A.getCacheString()).toBe("_dc")});it("should have timeout equal to 30000",function(){expect(A.getTimeout()).toBe(30000)});it("should have extraParams",function(){expect(A.getExtraParams()).toEqual(E.extraParams)});it("should have reader",function(){expect(A.getReader()).toBe(E.reader)});it("should have writer",function(){expect(A.getWriter()).toBe(E.writer)})});describe("methods",function(){describe("CRUD Operations",function(){beforeEach(function(){A=new C();A.doRequest=jasmine.createSpy()});describe("create",function(){it("should do a request",function(){A.read("create","create");expect(A.doRequest).toHaveBeenCalledWith("create","create")})});describe("read",function(){it("should do a request",function(){A.read("read","read");expect(A.doRequest).toHaveBeenCalledWith("read","read")})});describe("update",function(){it("should do a request",function(){A.read("update","update");expect(A.doRequest).toHaveBeenCalledWith("update","update")})});describe("destroy",function(){it("should do a request",function(){A.read("destroy","destroy");expect(A.doRequest).toHaveBeenCalledWith("destroy","destroy")})})});describe("buildUrl",function(){var E=new Ext.data.Request({url:"keep"}),F={noCache:false},G={cacheString:"_cool"};beforeEach(function(){spyOn(Ext.Date,"now").andReturn("bro")});it("should return keep?_dc=bro with an empty config",function(){A=new C({});expect(A.buildUrl(E),"keep?_dc=bro")});it("should disable caching",function(){A=new C(F);expect(A.buildUrl(E),E.url)});it("should use cacheString",function(){A=new C(G);expect(A.buildUrl(E),"keep?_cool=bro")});describe("url precedence",function(){it("should use the url on the proxy as a default",function(){A=new C({url:"proxy",noCache:false});expect(A.buildUrl(new Ext.data.Request())).toBe("proxy")});it("should use the specified api by default",function(){A=new C({api:{read:"read"},noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"read"}))).toBe("read")});it("should use the url on the request by default",function(){A=new C({noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"read",url:"request"}))).toBe("request")});it("should use proxy url if the item in the proxy is undefined",function(){A=new C({url:"proxy",api:{read:"read"},noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"update"}))).toBe("proxy")});it("should favour the api over the proxy url",function(){A=new C({url:"proxy",api:{read:"read"},noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"read"}))).toBe("read")});it("should favour the request url over the proxy",function(){A=new C({url:"proxy",noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"update",url:"request"}))).toBe("request")});it("should favour the request url over the api",function(){A=new C({api:{read:"read"},noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"read",url:"request"}))).toBe("request")});it("should favour the request url over proxy & api",function(){A=new C({url:"proxy",api:{read:"read"},noCache:false});expect(A.buildUrl(new Ext.data.Request({action:"read",url:"request"}))).toBe("request")})})});describe("doRequest",function(){it("should throw an error",function(){expect(C.prototype.doRequest).toThrow()})});describe("getParams",function(){var K,G,J,H;function E(L){return new Ext.data.proxy.Server(L||{})}function I(L){return new Ext.data.operation.Read(Ext.apply({},L,{page:10,start:100,limit:10,grouper:H,sorters:G,filters:J}))}function F(L,O){var M=E(L),N=I(O);return M.getParams(N)}beforeEach(function(){G=[new Ext.util.Sorter({property:"name",direction:"ASC"})];J=[new Ext.util.Filter({property:"name",value:"Ed"})];H=new Ext.util.Grouper({property:"name",direction:"ASC"})});describe("the page param",function(){it("should default to 'page'",function(){K=F();expect(K.page).toBe(10)});it("should be customizable",function(){K=F({pageParam:"thePage"});expect(K.thePage).toBe(10)});it("should not be sent if undefined",function(){K=F({pageParam:undefined});expect(K.page).toBeUndefined()})});describe("the start param",function(){it("should default to 'start'",function(){K=F();expect(K.start).toBe(100)});it("should be customizable",function(){K=F({startParam:"theStart"});expect(K.theStart).toBe(100)});it("should not be sent if undefined",function(){K=F({startParam:undefined});expect(K.start).toBeUndefined()});it("should send a startParam of 0",function(){K=F(undefined,{start:0});expect(K.start).toBe(0)})});describe("the limit param",function(){it("should default to 'limit'",function(){K=F();expect(K.limit).toBe(10)});it("should be customizable",function(){K=F({limitParam:"theLimit"});expect(K.theLimit).toBe(10)});it("should not be sent if undefined",function(){K=F({limitParam:undefined});expect(K.limit).toBeUndefined()})});describe("the group param",function(){it("should default to 'group'",function(){K=F();expect(K.group).toBe('{"property":"name","direction":"ASC"}')});it("should be customizable",function(){K=F({groupParam:"theGroup"});expect(K.theGroup).toBe('{"property":"name","direction":"ASC"}')});it("should not be sent if undefined",function(){K=F({groupParam:undefined});expect(K.group).toBeUndefined()});it("should not be set if there is no group defined",function(){K=F({},{grouper:undefined});expect(K.group).toBeUndefined()})});describe("the sort param",function(){beforeEach(function(){spyOn(Ext.data.proxy.Server.prototype,"encodeSorters").andReturn("sorters")});it("should default to 'sort'",function(){K=F();expect(K.sort).toBe("sorters")});it("should be customizable",function(){K=F({sortParam:"theSorters"});expect(K.theSorters).toBe("sorters")});it("should not be sent if undefined",function(){K=F({sortParam:undefined});expect(K.sort).toBeUndefined()});it("should encode the sorters",function(){F();expect(Ext.data.proxy.Server.prototype.encodeSorters).toHaveBeenCalledWith(G)});it("should not be set if there are no sorters",function(){K=F({},{sorters:[]});expect(K.sort).toBeUndefined()})});describe("the filter param",function(){beforeEach(function(){spyOn(Ext.data.proxy.Server.prototype,"encodeFilters").andReturn("filters")});it("should default to 'filter'",function(){K=F();expect(K.filter).toBe("filters")});it("should be customizable",function(){K=F({filterParam:"theFilters"});expect(K.theFilters).toBe("filters")});it("should not be sent if undefined",function(){K=F({filterParam:undefined});expect(K.filter).toBeUndefined()});it("should encode the filters",function(){F();expect(Ext.data.proxy.Server.prototype.encodeFilters).toHaveBeenCalledWith(J)});it("should not be set if there are no filters",function(){K=F({},{filters:[]});expect(K.filter).toBeUndefined()})})});describe("encoding sorters",function(){it("should provide a default encoded string",function(){var E=new Ext.util.Sorter({property:"name",direction:"ASC"});var F=new Ext.util.Sorter({property:"age",direction:"DESC"});A=new Ext.data.proxy.Server();expect(Ext.decode(A.encodeSorters([E,F]))).toEqual([{property:"name",direction:"ASC"},{property:"age",direction:"DESC"}])})});describe("encoding filters",function(){it("should provide a default encoded string, operator should be excluded by default",function(){var E=new Ext.util.Filter({property:"name",value:"Ed"});var F=new Ext.util.Filter({property:"age",value:25,operator:">"});A=new Ext.data.proxy.Server();expect(Ext.decode(A.encodeFilters([E,F]))).toEqual([{property:"name",value:"Ed"},{property:"age",value:25,operator:">"}])})});describe("encoding group data",function(){it("should JSON encode the data",function(){var E=new Ext.data.proxy.Server(),F=new Ext.util.Grouper({property:"name",direction:"ASC"});expect(Ext.decode(E.encodeSorters([F],true))).toEqual({property:"name",direction:"ASC"})})});describe("reader accessors",function(){var F,G="xml",I="xml",E="spec.SomeModel",H;beforeEach(function(){H=Ext.define(E,{extend:"Ext.data.Model",fields:["id"]})});describe("set the proxy's reader by reader instance",function(){beforeEach(function(){F={reader:B};A=new C(F)});it("should not create a new reader instance",function(){var J=false;spyOn(Ext,"createByAlias").andCallFake(function(K){if(K==="reader.json"){J=true}});expect(J).toBe(false)});it("should have a reader set",function(){expect(A.getReader()).toEqual(B)})});describe("set the proxy's reader by string",function(){beforeEach(function(){F={reader:G,proxy:A,model:H,defaultReaderType:I};A=new C(F)});it("should create a new reader instance",function(){expect(A.getReader().isReader).toBe(true)});it("should have a reader set",function(){expect(A.getReader().$className).toBe("Ext.data.reader.Xml")})})});describe("writer accessors",function(){var G,F="xml",E="xml",I="spec.SomeModel",H;beforeEach(function(){H=Ext.define(I,{extend:"Ext.data.Model",fields:["id"]})});describe("set the proxy's writer by writer instance",function(){beforeEach(function(){G={writer:D};A=new C(G)});it("should not create a new writer instance",function(){var J=false;spyOn(Ext,"createByAlias").andCallFake(function(K){if(K==="writer.json"){J=false}});expect(J).toBe(false)});it("should have a writer set",function(){expect(A.getWriter()).toEqual(D)})});describe("set the proxy's writer by string",function(){beforeEach(function(){G={writer:F,model:H,defaultWriterType:E};A=new C(G)});it("should create a new writer instance",function(){expect(A.getWriter().isWriter).toBe(true)});it("should have a writer set",function(){expect(A.getWriter().$className).toBe("Ext.data.writer.Xml")})})});describe("destroy",function(){var E,F;beforeEach(function(){E={reader:B,writer:D};A=new C(E)});it("should destroy reader and writer",function(){F=spyOn(Ext,"destroy");A.onDestroy();expect(F).toHaveBeenCalledWith(B,D)})})})});